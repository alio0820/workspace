var AjaxForm=new Class({Implements:Options,options:{loginBeforeSubmit:false,onRequest:function(){return true},onComplete:function(b,a){},onFailure:function(){alert("发生网络传输错误，请重试")}},initialize:function(a,b){this.setOptions(b);this.hasFileUpload=false;this.formElement=a;this.bind();this.enableButtons()},allButtons:[],bind:function(){this.allButtons=[];var a=this;a.formElement.getElements("input,button").each(function(c){var b=c.get("type");if(c.tagName=="button"||b=="button"||b=="submit"||b=="reset"){a.allButtons.push(c)}if(c.get("type")=="file"){a.hasFileUpload=c}});if(a.hasFileUpload){a.frameId="f"+$time();a.formElement.set("target",a.frameId);a.loading=false;a.formElement.addEvent("submit",function(b){new Event(b).stop();a.disableButtons();if(a.options.loginBeforeSubmit){login.popupLogin(function(){if(a.options.onRequest&&typeof(a.options.onRequest)=="function"){a.loading=a.options.onRequest.call(a.formElement)}else{a.loading=true}if(!a.loading){a.enableButtons()}else{a.formElement.submit()}},{hideCallback:function(){a.enableButtons()}})}else{if(a.options.onRequest&&typeof(a.options.onRequest)=="function"){a.loading=a.options.onRequest.call(a.formElement)}else{a.loading=true}if(!a.loading){a.enableButtons()}else{a.formElement.submit()}}});new Element("iframe",{id:a.frameId,name:a.frameId,styles:{display:"none"},src:"about:blank",events:{load:function(){if(a.loading){a.enableButtons();var e=$(a.frameId).contentWindow.document;if(e){if(e.location.href=="about:blank"){if(a.options.onFailure&&typeof(a.options.onFailure)=="function"){a.options.onFailure.call(a.formElement)}}if(a.options.onComplete&&typeof(a.options.onComplete)=="function"){var b=$(e.body);var d=b.get("text");var c=b.get("html");a.options.onComplete.call(a.formElement,JSON.decode(d),c)}}else{if(a.options.onFailure&&typeof(a.options.onFailure)=="function"){a.options.onFailure.call(a.formElement)}}a.loading=false}}}}).inject(document.body)}else{a.formElement.addEvent("submit",function(){a.disableButtons();if(a.options.loginBeforeSubmit){login.popupLogin(function(){if(a.options.onRequest&&typeof(a.options.onRequest)=="function"){var c=a.options.onRequest.call(a,a.formElement);if(!c){a.enableButtons();return c}}a.ajaxJson();return false},{hideCallback:function(){a.enableButtons()}})}else{if(a.options.onRequest&&typeof(a.options.onRequest)=="function"){var b=a.options.onRequest.call(a,a.formElement);if(!b){a.enableButtons();return b}}a.ajaxJson()}return false})}},ajaxJson:function(){var a=this;new Request.JSON({url:this.formElement.get("ajax-form-action")||this.formElement.action,method:"post",onSuccess:function(c,b){a.enableButtons();if(a.options.onComplete&&typeof(a.options.onComplete)=="function"){a.options.onComplete.call(this,c,b)}}.bind(this),onFailure:function(b){if(a.options.onFailure&&typeof(a.options.onFailure)=="function"){a.options.onFailure.call(this,b)}a.enableButtons()}}).send(a.formElement.toQueryString())},enableButtons:function(){if(this.allButtons&&(this.allButtons instanceof Array)){this.allButtons.each(function(a){a.disabled=false})}},disableButtons:function(){if(this.allButtons&&(this.allButtons instanceof Array)){this.allButtons.each(function(a){a.disabled=true})}}});